# 系统设置开发需求文档

## 一、功能概述

系统设置模块用于管理 AI 模型配置，包括供应商管理、API 密钥配置、模型管理等功能。参考 Cherry Studio 的设计理念，提供直观易用的配置界面。

---

## 二、功能模块

### 2.1 供应商管理（Providers）

管理 AI 服务供应商的基本信息和 API 端点配置。

#### 数据结构

```typescript
interface Provider {
  id: number;
  name: string;           // 供应商名称，如 "OpenAI", "Anthropic", "Google"
  base_url: string;       // API 基础 URL
  api_key: string;        // API 密钥（加密存储，前端显示脱敏）
  is_enabled: boolean;    // 是否启用
  is_default: boolean;    // 是否为默认供应商
  created_at: datetime;
  updated_at: datetime;
}
```

#### 功能列表

| 功能 | 说明 |
|------|------|
| 查看供应商列表 | 展示所有已配置的供应商 |
| 添加供应商 | 支持添加新的 AI 服务供应商 |
| 编辑供应商 | 修改供应商名称、URL、API Key |
| 删除供应商 | 删除指定供应商（关联模型需先删除） |
| 启用/禁用供应商 | 快速切换供应商状态 |
| 设为默认 | 设置默认供应商 |
| 测试连接 | 验证 API Key 和 URL 是否可用 |

#### 预置供应商模板

系统预置常用供应商模板，用户可一键添加：

| 供应商 | 默认 Base URL |
|--------|---------------|
| OpenAI | `https://api.openai.com/v1` |
| Anthropic | `https://api.anthropic.com` |
| Google AI | `https://generativelanguage.googleapis.com` |
| Azure OpenAI | `https://{resource}.openai.azure.com` |
| DeepSeek | `https://api.deepseek.com` |
| 智谱 AI | `https://open.bigmodel.cn/api/paas/v4` |
| MiniMax | `https://api.minimax.chat/v1` |
| 月之暗面 | `https://api.moonshot.cn/v1` |
| 阿里云百炼 | `https://dashscope.aliyuncs.com/api/v1` |
| 自定义 | 用户自定义 URL |

---

### 2.2 模型管理（Models）

管理各供应商下的可用模型。

#### 数据结构

```typescript
interface Model {
  id: number;
  provider_id: number;    // 关联供应商
  model_id: string;       // 模型标识，如 "gpt-4o", "claude-3-opus"
  display_name: string;   // 显示名称
  is_enabled: boolean;    // 是否启用
  is_default: boolean;    // 是否为默认模型
  max_tokens: number;     // 最大 Token 数
  context_window: number; // 上下文窗口大小
  supports_vision: boolean; // 是否支持图像输入
  supports_function_call: boolean; // 是否支持函数调用
  created_at: datetime;
  updated_at: datetime;
}
```

#### 功能列表

| 功能 | 说明 |
|------|------|
| 查看模型列表 | 按供应商分组展示所有模型 |
| 添加模型 | 为指定供应商添加新模型 |
| 编辑模型 | 修改模型配置 |
| 删除模型 | 删除指定模型 |
| 启用/禁用模型 | 快速切换模型状态 |
| 设为默认 | 设置默认诊断模型 |
| 批量导入 | 从供应商 API 获取可用模型列表 |

#### 预置模型列表

各供应商的常用模型预置：

**OpenAI**
- gpt-4o / gpt-4o-mini
- gpt-4-turbo / gpt-4
- o1 / o1-mini / o1-pro

**Anthropic**
- claude-sonnet-4-20250514
- claude-3-5-sonnet-20241022
- claude-3-5-haiku-20241022
- claude-3-opus-20240229

**Google**
- gemini-2.5-pro / gemini-2.5-flash
- gemini-2.0-flash / gemini-2.0-flash-lite
- gemini-1.5-pro / gemini-1.5-flash

**DeepSeek**
- deepseek-chat
- deepseek-reasoner

---

### 2.3 系统配置（General Settings）

全局系统配置项。

#### 配置项

| 配置项 | 类型 | 说明 |
|--------|------|------|
| default_language | string | 默认诊断报告语言 (zh/en) |
| default_model | string | 默认诊断模型 |
| request_timeout | number | API 请求超时时间（秒） |
| max_retries | number | 失败重试次数 |
| enable_streaming | boolean | 是否启用流式输出 |
| log_level | string | 日志级别 |

---

## 三、页面设计

### 3.1 页面布局

```
┌─────────────────────────────────────────────────────────────────┐
│  系统设置                                                        │
├──────────────┬──────────────────────────────────────────────────┤
│              │                                                   │
│  [供应商管理] │   供应商列表                                      │
│              │   ┌─────────────────────────────────────────────┐ │
│  [模型管理]   │   │ ○ OpenAI                          [编辑][删除]│ │
│              │   │   https://api.openai.com/v1                 │ │
│  [系统配置]   │   │   API Key: sk-****...****  ✓ 已验证         │ │
│              │   │   模型: 5 个已启用                           │ │
│              │   ├─────────────────────────────────────────────┤ │
│              │   │ ○ Anthropic                       [编辑][删除]│ │
│              │   │   https://api.anthropic.com                 │ │
│              │   │   API Key: sk-****...****  ✗ 未验证          │ │
│              │   │   模型: 3 个已启用                           │ │
│              │   └─────────────────────────────────────────────┘ │
│              │                                                   │
│              │   [+ 添加供应商]                                   │
│              │                                                   │
└──────────────┴──────────────────────────────────────────────────┘
```

### 3.2 供应商编辑弹窗

```
┌───────────────────────────────────────────┐
│  编辑供应商                           [×] │
├───────────────────────────────────────────┤
│                                           │
│  供应商名称                               │
│  ┌─────────────────────────────────────┐  │
│  │ OpenAI                              │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  API Base URL                             │
│  ┌─────────────────────────────────────┐  │
│  │ https://api.openai.com/v1           │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  API Key                                  │
│  ┌─────────────────────────────────────┐  │
│  │ sk-xxxxxxxxxxxxxxxxxxxx         [👁] │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  ☑ 启用此供应商                           │
│  ☐ 设为默认供应商                         │
│                                           │
│  [测试连接]                               │
│                                           │
├───────────────────────────────────────────┤
│              [取消]        [保存]         │
└───────────────────────────────────────────┘
```

### 3.3 模型管理页面

```
┌─────────────────────────────────────────────────────────────────┐
│  模型管理                                    [+ 添加模型]        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  供应商筛选: [全部 ▼]    状态筛选: [全部 ▼]    🔍 搜索模型...    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  OpenAI (5 个模型)                                    [展开]││
│  ├─────────────────────────────────────────────────────────────┤│
│  │  ┌──────────────────────────────────────────────────────┐  ││
│  │  │ ☑ gpt-4o              GPT-4 Optimized        [默认]  │  ││
│  │  │   128K tokens | 支持视觉 | 支持函数调用              │  ││
│  │  └──────────────────────────────────────────────────────┘  ││
│  │  ┌──────────────────────────────────────────────────────┐  ││
│  │  │ ☑ gpt-4-turbo         GPT-4 Turbo                    │  ││
│  │  │   128K tokens | 支持视觉 | 支持函数调用              │  ││
│  │  └──────────────────────────────────────────────────────┘  ││
│  │  ┌──────────────────────────────────────────────────────┐  ││
│  │  │ ☐ gpt-3.5-turbo       GPT-3.5 Turbo      [已禁用]    │  ││
│  │  │   16K tokens | 支持函数调用                          │  ││
│  │  └──────────────────────────────────────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  Anthropic (3 个模型)                                 [展开]││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、API 设计

### 4.1 供应商 API

#### 获取供应商列表
```
GET /api/settings/providers
Response: {
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "OpenAI",
      "base_url": "https://api.openai.com/v1",
      "api_key_masked": "sk-****...****",
      "is_enabled": true,
      "is_default": true,
      "model_count": 5,
      "created_at": "2025-01-01T00:00:00Z"
    }
  ]
}
```

#### 创建供应商
```
POST /api/settings/providers
Body: {
  "name": "OpenAI",
  "base_url": "https://api.openai.com/v1",
  "api_key": "sk-xxxxxxxxxxxx",
  "is_enabled": true,
  "is_default": false
}
Response: {
  "success": true,
  "data": { "id": 1, ... }
}
```

#### 更新供应商
```
PUT /api/settings/providers/{id}
Body: {
  "name": "OpenAI",
  "base_url": "https://api.openai.com/v1",
  "api_key": "sk-xxxxxxxxxxxx",  // 可选，不传则不更新
  "is_enabled": true,
  "is_default": false
}
```

#### 删除供应商
```
DELETE /api/settings/providers/{id}
```

#### 测试供应商连接
```
POST /api/settings/providers/{id}/test
Response: {
  "success": true,
  "data": {
    "status": "connected",
    "latency_ms": 234,
    "available_models": ["gpt-4o", "gpt-4-turbo", ...]
  }
}
```

#### 获取预置供应商模板
```
GET /api/settings/providers/templates
Response: {
  "success": true,
  "data": [
    { "name": "OpenAI", "base_url": "https://api.openai.com/v1" },
    { "name": "Anthropic", "base_url": "https://api.anthropic.com" },
    ...
  ]
}
```

### 4.2 模型 API

#### 获取模型列表
```
GET /api/settings/models?provider_id=1&is_enabled=true
Response: {
  "success": true,
  "data": [
    {
      "id": 1,
      "provider_id": 1,
      "provider_name": "OpenAI",
      "model_id": "gpt-4o",
      "display_name": "GPT-4 Optimized",
      "is_enabled": true,
      "is_default": true,
      "max_tokens": 128000,
      "context_window": 128000,
      "supports_vision": true,
      "supports_function_call": true
    }
  ]
}
```

#### 创建模型
```
POST /api/settings/models
Body: {
  "provider_id": 1,
  "model_id": "gpt-4o",
  "display_name": "GPT-4 Optimized",
  "is_enabled": true,
  "max_tokens": 128000,
  "context_window": 128000,
  "supports_vision": true,
  "supports_function_call": true
}
```

#### 更新模型
```
PUT /api/settings/models/{id}
Body: {
  "display_name": "GPT-4 Optimized",
  "is_enabled": true,
  "is_default": true,
  ...
}
```

#### 删除模型
```
DELETE /api/settings/models/{id}
```

#### 从供应商获取可用模型
```
POST /api/settings/providers/{id}/fetch-models
Response: {
  "success": true,
  "data": {
    "models": [
      { "id": "gpt-4o", "name": "GPT-4 Optimized" },
      { "id": "gpt-4-turbo", "name": "GPT-4 Turbo" },
      ...
    ]
  }
}
```

### 4.3 系统配置 API

#### 获取系统配置
```
GET /api/settings/config
Response: {
  "success": true,
  "data": {
    "default_language": "zh",
    "default_model_id": 1,
    "request_timeout": 60,
    "max_retries": 3,
    "enable_streaming": false,
    "log_level": "INFO"
  }
}
```

#### 更新系统配置
```
PUT /api/settings/config
Body: {
  "default_language": "zh",
  "default_model_id": 1,
  "request_timeout": 60,
  ...
}
```

---

## 五、数据库设计

### 5.1 providers 表

```sql
CREATE TABLE providers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    base_url VARCHAR(500) NOT NULL,
    api_key_encrypted TEXT NOT NULL,      -- AES 加密存储
    is_enabled BOOLEAN DEFAULT TRUE,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_providers_is_enabled ON providers(is_enabled);
CREATE INDEX idx_providers_is_default ON providers(is_default);
```

### 5.2 models 表

```sql
CREATE TABLE models (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    provider_id INTEGER NOT NULL,
    model_id VARCHAR(100) NOT NULL,       -- 如 "gpt-4o"
    display_name VARCHAR(200) NOT NULL,   -- 如 "GPT-4 Optimized"
    is_enabled BOOLEAN DEFAULT TRUE,
    is_default BOOLEAN DEFAULT FALSE,
    max_tokens INTEGER,
    context_window INTEGER,
    supports_vision BOOLEAN DEFAULT FALSE,
    supports_function_call BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (provider_id) REFERENCES providers(id) ON DELETE CASCADE,
    UNIQUE(provider_id, model_id)
);

-- 索引
CREATE INDEX idx_models_provider_id ON models(provider_id);
CREATE INDEX idx_models_is_enabled ON models(is_enabled);
CREATE INDEX idx_models_is_default ON models(is_default);
```

### 5.3 system_config 表

```sql
CREATE TABLE system_config (
    key VARCHAR(100) PRIMARY KEY,
    value TEXT NOT NULL,
    value_type VARCHAR(20) DEFAULT 'string',  -- string/number/boolean/json
    description VARCHAR(500),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 初始数据
INSERT INTO system_config (key, value, value_type, description) VALUES
('default_language', 'zh', 'string', '默认诊断报告语言'),
('default_model_id', '1', 'number', '默认诊断模型ID'),
('request_timeout', '60', 'number', 'API请求超时时间(秒)'),
('max_retries', '3', 'number', '失败重试次数'),
('enable_streaming', 'false', 'boolean', '是否启用流式输出'),
('log_level', 'INFO', 'string', '日志级别');
```

---

## 六、安全设计

### 6.1 API Key 存储

- **加密方式**: 使用 AES-256-GCM 加密
- **密钥管理**: 加密密钥存储在环境变量 `ENCRYPTION_KEY` 中
- **前端显示**: 仅显示脱敏后的 Key（如 `sk-****...****`）
- **传输安全**: 全程 HTTPS

### 6.2 权限控制

| 操作 | 所需权限 |
|------|----------|
| 查看供应商/模型列表 | `settings:read` |
| 添加/编辑/删除供应商 | `settings:write` |
| 添加/编辑/删除模型 | `settings:write` |
| 修改系统配置 | `settings:admin` |
| 查看完整 API Key | `settings:admin` |

### 6.3 操作审计

所有设置变更需记录审计日志：
- 操作人
- 操作时间
- 操作类型
- 变更内容（API Key 变更仅记录"已更新"）

---

## 七、开发计划

### 阶段 1：数据库与后端 API（基础功能）
- [ ] 创建数据库表结构
- [ ] 实现供应商 CRUD API
- [ ] 实现模型 CRUD API
- [ ] 实现系统配置 API
- [ ] API Key 加密存储

### 阶段 2：前端页面（供应商管理）
- [ ] 设置页面布局与导航
- [ ] 供应商列表展示
- [ ] 添加/编辑供应商弹窗
- [ ] 供应商连接测试
- [ ] 供应商删除确认

### 阶段 3：前端页面（模型管理）
- [ ] 模型列表展示（按供应商分组）
- [ ] 添加/编辑模型弹窗
- [ ] 模型启用/禁用切换
- [ ] 设置默认模型
- [ ] 从供应商获取模型列表

### 阶段 4：系统配置与集成
- [ ] 系统配置页面
- [ ] 诊断模块集成（使用配置的供应商和模型）
- [ ] 迁移现有 models.json 配置
- [ ] i18n 国际化支持

### 阶段 5：安全与优化
- [ ] 权限控制实现
- [ ] 操作审计日志
- [ ] 错误处理优化
- [ ] 单元测试

---

## 八、与现有系统集成

### 8.1 迁移策略

1. **保留兼容性**: 新系统上线初期，保留 `apikey.env` 和 `models.json` 配置文件作为后备
2. **优先级**: 数据库配置 > 环境变量配置 > JSON 文件配置
3. **迁移脚本**: 提供一键迁移脚本，将现有配置导入数据库

### 8.2 诊断模块改造

修改 `Utils/Agents.py` 和相关模块：

```python
# 原有方式
api_key = os.getenv("OPENAI_API_KEY")
base_url = os.getenv("OPENAI_BASE_URL")

# 新方式
from api.utils.settings_loader import get_active_provider

provider = get_active_provider()  # 获取默认或指定供应商
api_key = provider.api_key
base_url = provider.base_url
model = provider.default_model
```

### 8.3 前端模型选择改造

修改病例详情页的模型选择下拉框：
- 改为调用 `/api/settings/models?is_enabled=true` 获取可用模型列表
- 按供应商分组显示
- 显示模型的完整信息（名称、能力标签）

---

## 九、参考设计

### Cherry Studio 设置界面参考

Cherry Studio 的设置界面具有以下特点：
1. 左侧导航 + 右侧内容的经典布局
2. 供应商以卡片形式展示
3. API Key 输入框支持显示/隐藏切换
4. 一键测试连接功能
5. 模型列表支持搜索和筛选
6. 清晰的状态指示（已连接/未连接/错误）

本系统将借鉴这些设计理念，结合现有 UI 风格实现。
