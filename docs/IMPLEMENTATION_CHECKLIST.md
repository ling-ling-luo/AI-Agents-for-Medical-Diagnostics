# 病例导入功能增强 - 实施清单

## 📋 快速概览

**方案名称**: 病例新增与导入功能优化
**目标**: 打造高可用、用户友好的病例导入体验
**预计工作量**: 34 小时
**关键改进**: TXT 解析成功率从 < 30% 提升到 > 95%

---

## 🎯 核心问题与解决方案

### 问题 1: TXT 文件解析能力不足 🔴
**现状**: 只能识别简单格式，无法处理标准病例模板
**解决方案**:
- 创建智能 TXT 解析器（`api/utils/txt_parser.py`）
- 支持标准英文/中文/混合格式
- 自动降级策略，确保不崩溃

### 问题 2: 导入体验不够友好 🟡
**现状**: 无格式说明、无示例、无预览
**解决方案**:
- 创建导入向导组件（`ImportWizard.tsx`）
- 提供示例文件下载
- 分步骤引导用户

### 问题 3: 错误处理不够完善 🟡
**现状**: 错误信息模糊，用户不知道如何修复
**解决方案**:
- 详细的字段级错误提示
- 修复建议
- 失败案例详情展示

---

## ✅ 实施清单

### Phase 1: 后端开发（16 小时）

- [ ] **1.1 创建智能 TXT 解析器** (8h)
  - [ ] 定义解析器接口和数据结构
  - [ ] 实现标准英文格式解析（PATTERNS_EN）
  - [ ] 实现标准中文格式解析（PATTERNS_ZH）
  - [ ] 实现混合格式解析
  - [ ] 实现降级解析策略（fallback）
  - [ ] 实现格式自动检测（_detect_format）
  - [ ] 实现数据清洗和验证
  - [ ] 实现置信度计算

- [ ] **1.2 编写单元测试** (4h)
  - [ ] 测试标准英文格式
  - [ ] 测试标准中文格式
  - [ ] 测试混合格式
  - [ ] 测试降级解析
  - [ ] 测试错误处理
  - [ ] 测试边界条件

- [ ] **1.3 更新导入 API** (4h)
  - [ ] 集成新的 TXT 解析器
  - [ ] 增强错误信息结构
  - [ ] 添加详细的修复建议
  - [ ] 更新响应格式

---

### Phase 2: 前端开发（12 小时）

- [ ] **2.1 创建导入向导组件** (8h)
  - [ ] 创建 `ImportWizard.tsx` 文件
  - [ ] 实现步骤指示器
  - [ ] 实现文件选择步骤
    - [ ] 文件上传区域（支持点击和拖拽）
    - [ ] 格式说明卡片
    - [ ] 示例文件下载功能
  - [ ] 实现验证步骤
    - [ ] 文件类型验证
    - [ ] 文件大小验证
    - [ ] 验证结果展示
  - [ ] 实现上传步骤
    - [ ] 上传进度展示
    - [ ] 加载动画
  - [ ] 实现结果步骤
    - [ ] 成功/失败状态展示
    - [ ] 失败详情列表
    - [ ] 操作按钮（继续导入/完成）

- [ ] **2.2 更新路由和导航** (2h)
  - [ ] 在 `App.tsx` 添加 `/import` 路由
  - [ ] 更新 `CaseList.tsx` 导入按钮跳转逻辑
  - [ ] 测试页面跳转流程

- [ ] **2.3 样式和交互优化** (2h)
  - [ ] 统一设计风格（与现有页面一致）
  - [ ] 响应式布局适配
  - [ ] 动画和过渡效果
  - [ ] 无障碍访问（ARIA 标签）

---

### Phase 3: 测试与验证（6 小时）

- [ ] **3.1 集成测试** (3h)
  - [ ] 测试完整导入流程（TXT）
  - [ ] 测试完整导入流程（JSON）
  - [ ] 测试错误处理流程
  - [ ] 测试边界条件

- [ ] **3.2 端到端测试** (2h)
  - [ ] 使用真实病例文件测试
  - [ ] 测试并发导入
  - [ ] 性能测试

- [ ] **3.3 用户验收测试** (1h)
  - [ ] 验证用户体验
  - [ ] 验证错误提示清晰度
  - [ ] 验证导入成功率

---

## 📁 需要创建/修改的文件

### 新建文件 ✨
1. `api/utils/txt_parser.py` - 智能 TXT 解析器
2. `frontend/src/components/ImportWizard.tsx` - 导入向导组件
3. `tests/test_txt_parser.py` - 解析器单元测试
4. `tests/test_import_flow.py` - 集成测试

### 修改文件 ✏️
1. `api/main.py` - 更新导入 API（295-457 行）
2. `frontend/src/App.tsx` - 添加路由
3. `frontend/src/components/CaseList.tsx` - 更新导入按钮
4. `API_DOCUMENTATION.md` - 更新 API 文档

---

## 🧪 测试用例准备

### 测试文件清单
- [ ] `test_case_standard_en.txt` - 标准英文格式（Robert Miller 模板）
- [ ] `test_case_standard_zh.txt` - 标准中文格式
- [ ] `test_case_mixed.txt` - 混合格式
- [ ] `test_case_invalid.txt` - 无效格式（测试降级）
- [ ] `test_case_missing_fields.txt` - 缺少必填字段
- [ ] `test_cases_batch.json` - JSON 批量导入（10 条）
- [ ] `test_case_duplicate.txt` - 重复病历号
- [ ] `test_case_large.txt` - 大文件（接近 10MB）

---

## 🚀 实施顺序建议

### Day 1-2: 后端核心功能
1. 创建并实现 TXT 解析器（最重要）
2. 编写单元测试
3. 更新导入 API

### Day 3: 前端核心功能
1. 创建导入向导组件
2. 实现主要交互流程

### Day 4: 集成与测试
1. 前后端集成
2. 端到端测试
3. 修复 bug

### Day 5: 优化与收尾
1. 性能优化
2. 用户体验调整
3. 文档更新

---

## ⚠️ 风险提示

### 高风险项 🔴
1. **正则表达式复杂度**
   - 风险：不同格式病例差异大，正则可能不够鲁棒
   - 缓解：多轮测试，完善降级策略

2. **字符编码问题**
   - 风险：TXT 文件可能是 GBK、UTF-8 等不同编码
   - 缓解：自动检测编码，优雅降级

### 中风险项 🟡
1. **性能瓶颈**
   - 风险：大文件解析可能慢
   - 缓解：异步处理，进度反馈

2. **前端兼容性**
   - 风险：不同浏览器文件 API 差异
   - 缓解：充分测试主流浏览器

---

## 📊 验收标准

### 功能完整性 ✅
- [x] 支持标准英文病例模板
- [x] 支持标准中文病例模板
- [x] 提供导入向导界面
- [x] 提供示例文件下载
- [x] 详细的错误提示

### 性能指标 📈
- [ ] TXT 解析成功率 > 95%（标准格式）
- [ ] 单文件导入时间 < 3 秒
- [ ] 100 条病例批量导入 < 10 秒

### 用户体验 😊
- [ ] 导入流程步骤清晰（≤ 4 步）
- [ ] 错误信息友好易懂
- [ ] 有明确的进度反馈

### 代码质量 💎
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] 代码 Review 通过

---

## 📞 需要确认的问题

### 技术问题
1. [ ] 是否需要支持其他字符编码（如 GBK）？
2. [ ] 是否需要异步处理大文件（>100 条病例）？
3. [ ] 是否需要导入进度的后台查询接口？

### 产品问题
1. [ ] 导入失败时，是否需要提供"编辑后重试"功能？
2. [ ] 是否需要"导入历史"记录？
3. [ ] 是否需要支持导入预览（导入前查看将要创建的病例）？

---

## 🎯 下一步行动

### 立即行动 ⏰
1. **审阅方案文档**（`CASE_IMPORT_ENHANCEMENT_PLAN.md`）
2. **确认技术和产品问题**
3. **获得审批签字**

### 审批通过后 🚀
1. 创建 Git 分支：`feature/import-enhancement`
2. 按照清单顺序开始实施
3. 每完成一个阶段进行 Code Review

---

**文档版本**: v1.0
**最后更新**: 2025-01-24
**状态**: ⏳ 待审批
