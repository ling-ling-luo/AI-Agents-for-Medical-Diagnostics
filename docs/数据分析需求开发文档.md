# 数据分析需求开发文档

## 一、项目可量化数据清单

### 1. 病例相关指标

#### 1.1 基础统计
- **总病例数**（Total Cases）
  - 数据来源：`medical_cases` 表的记录总数
  - 时间维度：可按创建时间过滤
  - 权限维度：普通用户只看自己创建的病例

- **病例创建趋势**（Case Creation Trends）
  - 数据来源：`medical_cases.created_at`
  - 时间粒度：日/周/月
  - 可视化：折线图

#### 1.2 人口统计学数据
- **年龄分布**（Age Distribution）
  - 数据来源：`medical_cases.age`
  - 分组：0-10, 11-20, 21-30, 31-40, 41-50, 51-60, 61-70, 71-80, 81-90, 90+
  - 可视化：柱状图

- **性别分布**（Gender Distribution）
  - 数据来源：`medical_cases.gender`
  - 类型：male/female/other/未知
  - 可视化：饼图

- **年龄-性别交叉分析**（Age-Gender Matrix）
  - 复合维度分析
  - 可视化：热力图或分组柱状图

#### 1.3 病例属性分析
- **主诉类型分布**（Chief Complaint Categories）
  - 数据来源：`medical_cases.chief_complaint`（需文本分类）
  - 可通过关键词提取常见主诉

---

### 2. 诊断相关指标

#### 2.1 执行统计
- **总诊断执行次数**（Total Diagnoses）
  - 数据来源：`diagnosis_history` 表的记录总数
  - 时间维度：可按 `run_timestamp` 过滤

- **诊断趋势**（Diagnosis Trends）
  - 数据来源：`diagnosis_history.run_timestamp`
  - 时间粒度：日/周/月
  - 可视化：折线图

- **诊断完成率**（Completion Rate）
  - 计算公式：有诊断记录的病例数 / 总病例数 × 100%
  - 用于衡量系统使用深度

#### 2.2 性能指标
- **平均执行时间**（Average Execution Time）
  - 数据来源：`diagnosis_history.execution_time_ms`
  - 统计：平均值、中位数、P95、P99
  - 可视化：趋势图、分布直方图

- **执行时间分布**（Execution Time Distribution）
  - 分段：0-5s, 5-10s, 10-20s, 20-30s, 30s+
  - 可视化：柱状图

#### 2.3 模型对比
- **模型使用频率**（Model Usage Frequency）
  - 数据来源：`diagnosis_history.model_name`
  - 统计：各模型被使用的次数
  - 可视化：饼图或柱状图

- **模型性能对比**（Model Performance Comparison）
  - 维度：平均执行时间、使用次数
  - 可视化：分组柱状图或雷达图

---

### 3. 用户活动指标

#### 3.1 活跃度统计
- **活跃用户数**（Active Users）
  - 定义：在时间范围内创建过病例或运行过诊断的用户数
  - 数据来源：`medical_cases.created_by` 和 `users.last_login`

- **用户活动排行**（Top Active Users）
  - 维度：创建病例数、运行诊断数
  - 可视化：排行榜表格

#### 3.2 用户行为分析
- **单用户病例数分布**（Cases per User Distribution）
  - 统计每个用户创建的病例数
  - 可视化：柱状图

- **用户诊断频次**（Diagnosis Frequency per User）
  - 统计每个用户运行诊断的频次
  - 可视化：柱状图

---

### 4. 时间维度分析

#### 4.1 时间序列趋势
- **病例创建时间序列**（按日/周/月）
- **诊断执行时间序列**（按日/周/月）
- **执行时间趋势**（平均执行时间的时间序列）

#### 4.2 时间分布
- **创建时间分布**（按小时/星期几）
  - 分析用户使用习惯
  - 可视化：热力图

---

### 5. 权限与范围控制

根据 RBAC 系统：
- **管理员（admin）**：查看所有数据，导出报告
- **医生（doctor）**：查看所有数据，无导出权限
- **普通用户（viewer）**：只查看自己创建的病例和诊断数据

---

## 二、数据分析页面需求开发文档

### 1. 页面概述

**页面名称**：数据分析仪表盘（Data Analytics Dashboard）

**访问路径**：`/data-analysis`

**权限要求**：
- 需要登录
- 需要 `analytics:read` 权限（管理员和医生角色）

**技术栈**：
- 前端：React 19 + TypeScript + Tailwind CSS + Recharts
- 后端：FastAPI + SQLAlchemy
- 已实现：完整的后端 API（8个端点）和前端基础组件

---

### 2. 页面结构

#### 2.1 顶部筛选器区域
```
┌─────────────────────────────────────────────────────┐
│ 数据分析 (Data Analysis)                              │
├─────────────────────────────────────────────────────┤
│ 日期范围: [今天 ▼] [自定义: 开始日期 | 结束日期]        │
│ 预设: 今天 | 最近7天 | 最近30天 | 最近3个月 | 自定义    │
└─────────────────────────────────────────────────────┘
```

已实现组件：`DateRangePicker`

#### 2.2 标签页导航
```
[概览 Overview] [人口统计 Demographics] [趋势分析 Trends] [模型对比 Models] [用户活动 Users]
```

---

### 3. 各标签页详细设计

#### 标签页 1：概览（Overview）

**布局**：卡片网格（3列响应式）

**内容卡片**：
1. **总病例数**
   - 数值：大号显示
   - 趋势：与上期对比（↑ 12%）
   - 图标：BarChart3

2. **总诊断数**
   - 数值：大号显示
   - 趋势：与上期对比
   - 图标：Activity

3. **平均执行时间**
   - 数值：秒为单位（如 8.5s）
   - 趋势：与上期对比
   - 图标：Clock

4. **诊断完成率**
   - 数值：百分比（如 85%）
   - 进度条显示
   - 图标：CheckCircle

5. **活跃用户数**
   - 数值：在时间范围内的活跃用户
   - 图标：UserCheck

**实现状态**：✅ 已完成（frontend/src/pages/DataAnalysis.tsx:188-236）

---

#### 标签页 2：人口统计（Demographics）

**图表1：年龄分布（Bar Chart）**
- X轴：年龄段（0-10, 11-20, ...）
- Y轴：病例数
- 交互：点击年龄段可下钻查看详情

**图表2：性别分布（Pie Chart）**
- 分类：男性/女性/其他/未知
- 显示百分比和数量
- 颜色区分

**图表3：年龄-性别矩阵（Heatmap / Grouped Bar Chart）**
- 二维交叉分析
- 可切换视图类型

**实现状态**：✅ 已完成年龄和性别图表（frontend/src/pages/DataAnalysis.tsx:238-286）

---

#### 标签页 3：趋势分析（Trends）

**时间粒度选择器**：
```
[ 日 Day ] [ 周 Week ] [ 月 Month ]  ← 按钮组
```

**图表1：病例创建趋势（Line Chart）**
- X轴：时间（按粒度）
- Y轴：创建数量
- 折线：显示趋势
- 可叠加对比不同时间段

**图表2：诊断执行趋势（Line Chart）**
- 与病例趋势类似
- 可双Y轴对比病例数和诊断数

**图表3：执行时间趋势（Line Chart）**
- Y轴：平均执行时间（秒）
- 折线：显示性能变化趋势
- 区间显示：P95/P99 带状区域

**实现状态**：✅ 已完成病例和诊断趋势图表（frontend/src/pages/DataAnalysis.tsx:288-363）

---

#### 标签页 4：模型对比（Models）

**当前已实现API**：`/api/analytics/models/comparison`

**图表1：模型使用频率（Pie Chart）**
- 显示各模型被使用的占比
- 标注具体次数

**图表2：模型性能对比（Grouped Bar Chart）**
- X轴：模型名称
- Y轴1：平均执行时间
- Y轴2：使用次数
- 双Y轴或分组柱状图

**图表3：执行时间箱线图（Box Plot）**
- 对比各模型的执行时间分布
- 显示中位数、四分位数、异常值

**实现状态**：⏳ 待实现（API已就绪：api/routes/analytics.py:185-211）

---

#### 标签页 5：用户活动（Users）

**当前已实现API**：`/api/analytics/users/activity`

**图表1：活跃用户排行（Table）**
| 用户名 | 病例数 | 诊断数 | 最后活动时间 |
|--------|--------|--------|--------------|
| ...    | ...    | ...    | ...          |

**图表2：用户病例数分布（Histogram）**
- X轴：病例数区间（1-5, 6-10, 11-20, ...）
- Y轴：用户数

**图表3：用户活跃度时间分布（Heatmap）**
- X轴：小时（0-23）
- Y轴：星期（周一-周日）
- 热力值：活动次数

**实现状态**：⏳ 待实现（API已就绪：api/routes/analytics.py:214-240）

---

### 4. 导出功能设计

**位置**：页面右上角"导出报告"按钮

**导出选项**：
- 格式：PDF / Excel
- 报告类型：
  - 综合概览报告
  - 人口统计报告
  - 趋势分析报告
  - 模型性能报告

**权限要求**：`analytics:export`（仅管理员）

**实现状态**：⏳ 待实现（API端点已定义但未实现逻辑：api/routes/analytics.py:243-275）

---

### 5. 响应式设计要求

**桌面端（≥1024px）**：
- 卡片网格：3列
- 图表并排显示

**平板端（768px - 1023px）**：
- 卡片网格：2列
- 图表垂直堆叠

**移动端（<768px）**：
- 卡片网格：1列
- 图表全宽显示
- 简化交互

---

### 6. 性能优化要求

1. **数据加载**：
   - 初次加载仅请求当前标签页数据
   - 切换标签页时按需加载
   - 实现数据缓存（5分钟有效期）

2. **大数据处理**：
   - 后端分页支持（表格数据）
   - 前端虚拟滚动（大量数据点）
   - 图表采样（数据点>500时）

3. **加载状态**：
   - Skeleton Screen（骨架屏）
   - 加载动画
   - 错误重试机制

---

### 7. 国际化支持

**已支持语言**：
- 中文（zh-CN）
- 英文（en-US）

**翻译覆盖**：
- 页面标题和标签页
- 图表标题和轴标签
- 数据指标名称
- 错误提示信息

**实现状态**：✅ 已完成（frontend/src/i18n/locales/zh-CN.json:289-340, en-US.json:289-340）

---

### 8. 开发优先级建议

#### 已完成（✅）：
- ✅ 阶段1：后端基础设施（8个API端点）
- ✅ 阶段2：前端基础组件（AnalyticsCard, ChartContainer, DateRangePicker）
- ✅ 阶段3：核心分析页面（Overview, Demographics, Trends标签页）

#### 待实现（⏳）：
- ⏳ **阶段4：高级分析功能**
  - 模型对比标签页（前端UI + 数据整合）
  - 用户活动标签页（前端UI + 数据整合）
  - 交互式筛选器（多维度组合筛选）
  - 图表交互增强（下钻、缩放、导出图片）

- ⏳ **阶段5：导出与优化**
  - 导出功能实现（PDF/Excel生成）
  - 性能优化（数据缓存、分页）
  - 自动刷新机制
  - 对比分析功能（时间段对比）

---

## 三、技术实现要点

### 1. 后端API规范

#### 统一响应格式
```json
{
    "success": true,
    "data": { ... },
    "meta": {
        "date_range": {"start": "2024-01-01", "end": "2024-12-31"},
        "total_count": 1500,
        "filters_applied": {...}
    }
}
```

#### 已实现的API端点

| 端点 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/analytics/overview` | GET | 概览数据 | analytics:read |
| `/api/analytics/cases/demographics` | GET | 人口统计 | analytics:read |
| `/api/analytics/cases/trends` | GET | 病例趋势 | analytics:read |
| `/api/analytics/diagnoses/performance` | GET | 诊断性能 | analytics:read |
| `/api/analytics/diagnoses/trends` | GET | 诊断趋势 | analytics:read |
| `/api/analytics/models/comparison` | GET | 模型对比 | analytics:read |
| `/api/analytics/users/activity` | GET | 用户活动 | analytics:read |
| `/api/analytics/export` | POST | 导出报告 | analytics:export |

---

### 2. 前端状态管理

```typescript
// 每个标签页独立管理：
const [overviewData, setOverviewData] = useState<OverviewData | null>(null);
const [loadingOverview, setLoadingOverview] = useState(false);
const [errorOverview, setErrorOverview] = useState<string | null>(null);
```

---

### 3. 数据刷新策略
- 手动刷新按钮
- 日期范围变更时自动刷新
- 可选：30秒自动刷新（实时监控场景）

---

## 四、测试建议

### 1. 单元测试
- 数据聚合函数（analytics.py）
- 时间粒度计算逻辑
- 权限过滤逻辑

### 2. 集成测试
- API端点完整流程测试
- 权限边界测试（不同角色访问）
- 大数据量性能测试

### 3. 前端测试
- 图表渲染测试（不同数据情况）
- 响应式布局测试
- 国际化切换测试

---

## 五、数据库模型参考

### MedicalCase 表
```python
id: Integer (主键)
patient_id: String(50) (唯一，病历号)
patient_name: String(100) (患者姓名)
age: Integer (年龄)
gender: String(10) (性别: male/female/other)
chief_complaint: Text (主诉)
raw_report: Text (原始病历全文)
created_by: Integer (创建者ID)
created_at: DateTime (创建时间)
updated_at: DateTime (更新时间)
```

### DiagnosisHistory 表
```python
id: Integer (主键)
case_id: Integer (关联病例ID)
diagnosis_markdown: Text (AI诊断结果)
model_name: String(50) (使用的模型名称)
run_timestamp: DateTime (诊断运行时间)
execution_time_ms: Integer (执行耗时毫秒)
```

### User 表
```python
id: Integer (主键)
username: String(50) (用户名)
email: String(100) (邮箱)
full_name: String(100) (姓名)
is_active: Boolean (账户是否激活)
created_at: DateTime (创建时间)
last_login: DateTime (最后登录时间)
```

---

## 六、当前实现状态总结

### ✅ 已完成
1. **后端**：8个完整的分析API端点，支持RBAC权限控制
2. **前端基础组件**：3个可复用组件（AnalyticsCard, ChartContainer, DateRangePicker）
3. **核心页面**：Overview、Demographics、Trends三个标签页完整实现
4. **国际化**：中英文完整翻译
5. **权限集成**：admin和doctor角色可访问，viewer无权限

### ⏳ 待开发
1. **模型对比**和**用户活动**标签页的前端UI
2. **导出功能**的后端逻辑实现（PDF/Excel生成）
3. **性能优化**（缓存、分页、采样）
4. **高级交互**（图表下钻、对比分析、数据导出）

---

## 七、开发路线图

### 短期（1-2周）
- 完成模型对比标签页前端实现
- 完成用户活动标签页前端实现
- 添加图表交互功能（tooltips优化、点击事件）

### 中期（3-4周）
- 实现导出功能（PDF/Excel）
- 添加数据缓存机制
- 优化大数据量场景的性能

### 长期（1-2月）
- 添加对比分析功能（时间段对比、模型对比）
- 实现自定义报表功能
- 添加数据预警和异常检测
- 支持更多图表类型（雷达图、漏斗图等）

---

## 八、相关文件清单

### 后端文件
- `api/routes/analytics.py` - 分析API路由（275行）
- `api/utils/analytics.py` - 数据聚合逻辑（488行）
- `api/models/case.py` - 病例数据模型
- `api/models/user.py` - 用户权限模型
- `api/auth/permissions.py` - 权限检查器

### 前端文件
- `frontend/src/pages/DataAnalysis.tsx` - 主页面（367行）
- `frontend/src/components/analytics/AnalyticsCard.tsx` - 指标卡片组件
- `frontend/src/components/analytics/ChartContainer.tsx` - 图表容器组件
- `frontend/src/components/analytics/DateRangePicker.tsx` - 日期选择器
- `frontend/src/types/analytics.ts` - TypeScript类型定义（153行）
- `frontend/src/services/api.ts` - API调用封装
- `frontend/src/i18n/locales/zh-CN.json` - 中文翻译
- `frontend/src/i18n/locales/en-US.json` - 英文翻译

---

## 附录：API调用示例

### 获取概览数据
```bash
curl -X GET "http://localhost:8000/api/analytics/overview?start_date=2024-01-01&end_date=2024-12-31" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 获取人口统计
```bash
curl -X GET "http://localhost:8000/api/analytics/cases/demographics?start_date=2024-01-01" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 获取趋势数据
```bash
curl -X GET "http://localhost:8000/api/analytics/cases/trends?granularity=week" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

**文档版本**：v1.0
**最后更新**：2026-01-06
**维护者**：开发团队
