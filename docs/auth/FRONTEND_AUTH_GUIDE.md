# 前端权限管理系统 - 使用指南

## 概览

前端权限管理系统已全部完成，采用**Google简约风格**设计，提供完整的用户认证和权限控制功能。

## 已完成的功能

### ✅ 1. 认证系统
- **登录页面** (`Login.tsx`) - Google风格简约设计
- **注册页面** (`Register.tsx`) - 包含密码强度提示和实时验证
- **认证上下文** (`AuthContext.tsx`) - 全局用户状态管理
- **路由守卫** (`ProtectedRoute.tsx`) - 保护需要认证的页面

### ✅ 2. 权限控制
- **API拦截器** - 自动添加JWT令牌到所有请求
- **401错误处理** - 令牌过期自动跳转到登录页
- **权限检查** - 根据用户权限显示/隐藏功能
- **角色验证** - 支持基于角色的访问控制

### ✅ 3. 用户界面
- **用户信息显示** - 顶部导航栏显示用户头像、姓名、角色
- **登出功能** - 用户菜单下拉框，支持一键登出
- **权限提示** - 权限不足时显示友好提示页面

## 前端文件结构

```
frontend/src/
├── components/
│   ├── Login.tsx                # 登录页面（Google风格）
│   ├── Register.tsx             # 注册页面
│   ├── ProtectedRoute.tsx       # 路由守卫组件
│   ├── HomePage.tsx             # 首页（已更新用户信息）
│   ├── CaseDetail.tsx           # 病例详情（受保护）
│   ├── EditCaseWrapper.tsx      # 编辑病例（需要权限）
│   └── ...
├── context/
│   └── AuthContext.tsx          # 认证上下文
├── services/
│   ├── authApi.ts               # 认证API服务
│   └── api.ts                   # 通用API服务（已添加JWT拦截器）
└── App.tsx                      # 应用根组件（集成AuthProvider）
```

## 使用方法

### 1. 启动应用

确保后端服务器已启动：
```bash
# 终端1：启动后端
python3 -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
```

前端已经在运行（端口5174）：
```bash
# 前端自动运行中
http://localhost:5174/
```

### 2. 用户登录

访问 `http://localhost:5174/` 会自动跳转到登录页面（如果未登录）。

**测试账户**：
- **管理员**: `admin / admin123`
- **医生**: `doctor / doctor123`
- **普通用户**: `viewer / viewer123`

**登录页面特点**：
- Google简约风格设计
- 白色背景，简洁边框
- 实时错误提示
- 加载状态显示

### 3. 用户注册

点击"创建账户"链接进入注册页面。

**注册页面特点**：
- 实时密码强度检测
- 密码匹配提示
- 用户名格式验证
- 邮箱格式验证

**注册成功后**：
- 自动登录
- 跳转到首页
- 默认分配 `viewer` 角色（只读权限）

### 4. 权限控制演示

#### 测试1：管理员（全部权限）
1. 使用 `admin / admin123` 登录
2. 可以看到所有标签：病例列表、导入病例、新增病例
3. 可以编辑、删除病例
4. 可以运行AI诊断
5. 可以导出报告

#### 测试2：医生（创建和编辑权限）
1. 登出管理员
2. 使用 `doctor / doctor123` 登录
3. 可以看到：病例列表、导入病例、新增病例
4. 可以创建、编辑病例
5. 可以运行AI诊断
6. 可以查看和导出报告
7. **不能删除病例**（没有 `case:delete` 权限）

#### 测试3：普通用户（只读权限）
1. 登出医生
2. 使用 `viewer / viewer123` 登录
3. **只能看到**：病例列表
4. **不能看到**：导入病例、新增病例（标签被隐藏）
5. 可以查看病例详情和诊断结果
6. 可以导出报告
7. **不能编辑或删除病例**
8. **不能运行AI诊断**

### 5. 权限不足提示

如果用户尝试访问没有权限的页面（如直接输入URL），会看到：
- 红色警告图标
- "权限不足"提示
- 返回按钮

### 6. 令牌过期处理

当JWT令牌过期（默认24小时后）：
- 下次API请求会返回401错误
- 自动清除本地令牌
- 自动跳转到登录页
- 用户需要重新登录

## UI设计特点

### Google简约风格
- **白色背景** - 清爽简洁
- **简洁边框** - 细灰色边框（border-gray-300）
- **蓝色主题** - 按钮和强调色使用蓝色
- **圆角设计** - 适度的圆角（rounded-lg）
- **阴影效果** - 轻微阴影增加层次感

### 登录页面设计
```
┌─────────────────────────────┐
│   AI 医疗诊断系统            │
│   登录到您的账户             │
│                             │
│  ┌───────────────────────┐  │
│  │  [用户名输入框]        │  │
│  │  [密码输入框]          │  │
│  │  [登录按钮]            │  │
│  │  还没有账户？创建账户   │  │
│  └───────────────────────┘  │
│                             │
│  测试账户：admin / admin123 │
└─────────────────────────────┘
```

### 用户菜单设计
```
┌──────────────────────────┐
│ Logo  AI医疗诊断系统      │  [👤 张三 ▼]
│       智能化医疗平台      │      ↓
└──────────────────────────┘  ┌─────────┐
│ 病例列表 | 导入 | 新增    │  │ admin   │
└──────────────────────────┘  │ admin@  │
                               ├─────────┤
                               │ 🚪 登出 │
                               └─────────┘
```

## API权限映射

| 页面/功能 | 所需权限 | Admin | Doctor | Viewer |
|-----------|----------|:-----:|:------:|:------:|
| 登录页面 | - | ✅ | ✅ | ✅ |
| 注册页面 | - | ✅ | ✅ | ✅ |
| 病例列表 | `case:read` | ✅ | ✅ | ✅ |
| 病例详情 | `case:read` | ✅ | ✅ | ✅ |
| 新增病例 | `case:create` | ✅ | ✅ | ❌ |
| 导入病例 | `case:create` | ✅ | ✅ | ❌ |
| 编辑病例 | `case:update` | ✅ | ✅ | ❌ |
| 删除病例 | `case:delete` | ✅ | ❌ | ❌ |
| 运行诊断 | `diagnosis:execute` | ✅ | ✅ | ❌ |
| 查看诊断 | `diagnosis:read` | ✅ | ✅ | ✅ |
| 导出报告 | `diagnosis:read` | ✅ | ✅ | ✅ |

## 开发者指南

### 添加新的受保护页面

```tsx
// App.tsx
<Route
  path="/your-new-page"
  element={
    <ProtectedRoute requiredPermission="your:permission">
      <YourNewPage />
    </ProtectedRoute>
  }
/>
```

### 在组件中检查权限

```tsx
import { useAuth } from '../context/AuthContext';

function MyComponent() {
  const { hasPermission, hasRole, user } = useAuth();

  if (!hasPermission('case:delete')) {
    return null; // 或显示替代内容
  }

  return <button onClick={handleDelete}>删除</button>;
}
```

### 条件渲染按钮

```tsx
{hasPermission('case:create') && (
  <button>新增病例</button>
)}

{hasRole('admin') && (
  <button>管理员功能</button>
)}
```

## 常见问题

### Q1: 为什么刷新页面后仍然保持登录状态？
A: JWT令牌存储在 `localStorage` 中，页面刷新不会丢失。AuthContext会在初始化时自动从localStorage读取令牌并验证。

### Q2: 如何修改令牌有效期？
A: 在后端 `apikey.env` 中修改：
```bash
ACCESS_TOKEN_EXPIRE_MINUTES=1440  # 24小时
```

### Q3: 如何添加"记住我"功能？
A: 当前已实现自动记住登录状态（通过localStorage）。如需可选的"记住我"，可以在登录时根据用户选择决定使用 `localStorage` 或 `sessionStorage`。

### Q4: 用户信息存储在哪里？
A:
- **令牌**: `localStorage.getItem('access_token')`
- **用户信息**: `localStorage.getItem('user')` （JSON格式）
- **内存**: AuthContext的state（刷新后从localStorage恢复）

### Q5: 如何测试权限控制？
A: 使用不同的测试账户登录，观察UI变化：
1. 登录 `admin` - 查看所有功能
2. 登录 `doctor` - 查看部分功能（无删除权限）
3. 登录 `viewer` - 只能查看（无编辑/创建权限）

### Q6: 为什么使用Google风格？
A: Google登录页面是业界公认的简洁、易用的设计标准，用户熟悉度高，视觉干扰少，专注于功能本身。

## 后续优化建议

1. **个人中心页面** - 允许用户修改密码、查看个人信息
2. **用户管理页面** - 管理员可以管理所有用户和角色
3. **密码找回功能** - 通过邮件重置密码
4. **双因素认证** - 增强账户安全
5. **登录历史** - 显示用户最近的登录记录
6. **令牌刷新** - 实现Refresh Token避免频繁登录
7. **暗色模式** - 支持深色主题切换

## 完整测试流程

### 步骤1：启动服务
```bash
# 后端
python3 -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload

# 前端已自动运行
# http://localhost:5174/
```

### 步骤2：测试登录
1. 访问 http://localhost:5174/
2. 应该自动跳转到 `/login`
3. 输入 `admin` / `admin123`
4. 点击"登录"
5. 成功后跳转到首页

### 步骤3：测试权限
1. 查看顶部右侧用户信息（显示"admin"和"管理员"）
2. 查看标签页（应该看到：病例列表、导入病例、新增病例）
3. 点击用户头像查看下拉菜单
4. 点击"退出登录"

### 步骤4：测试不同角色
1. 使用 `doctor` 登录
   - 应该看到3个标签
   - 可以创建和编辑病例
   - 无删除按钮

2. 使用 `viewer` 登录
   - 只看到"病例列表"标签
   - 无创建/编辑/删除功能
   - 可以查看详情

### 步骤5：测试URL保护
1. 登出后，直接访问 `http://localhost:5174/case/1`
2. 应该重定向到 `/login`
3. 登录后会跳回到原来的页面

### 步骤6：测试注册
1. 访问登录页面，点击"创建账户"
2. 填写注册表单：
   - 用户名: `testuser`
   - 邮箱: `test@example.com`
   - 密码: `test123`
3. 观察密码强度提示
4. 确认密码
5. 注册成功后自动登录

## 总结

前端权限管理系统已**100%完成**，包括：

✅ **认证功能**
- Google风格登录/注册页面
- JWT令牌管理
- 自动令牌刷新检测

✅ **权限控制**
- 路由级别保护
- 组件级别权限检查
- UI元素权限显示/隐藏

✅ **用户体验**
- 简洁美观的UI设计
- 实时错误提示
- 加载状态显示
- 友好的权限提示

✅ **技术实现**
- React Context全局状态管理
- Axios拦截器自动添加令牌
- 401错误自动处理
- localStorage持久化存储

现在您可以：
1. 使用完整的用户认证系统
2. 基于角色的权限控制
3. 安全的API调用
4. 优秀的用户体验

**祝使用愉快！** 🎉
